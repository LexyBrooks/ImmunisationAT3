---
title: "LavaanTrial"
author: "Alex Brooks"
date: "10/9/2018"
output: html_document
---
#Testing SEM modelling using Lavaan package
Try using the immunization with everything including taxation dataset to play with.
Try to do exploratory factor analysis, when you have a dataset in shape
```{r setup, include=FALSE}
library(lavaan)
library(tidyverse)
library(dplyr)
options(scipen = 999)
```

## Manifest and Latent Variables

Abstract variables are latent - and not measured - and represented by a circle, while Manifest variables are concrete and represented by a square. You need 1 latent variable to 3 manifest variables.

Name your model - you need to specify it and fit it, so make the naming flexible

=~ is the symbol that represents the direction of the equation.

Typical form is 
visual.model <- 'visual.latent =~ manifest.variable1 + manifest.variable2 + manifest.variable3 ...'

A one factor model is measured by degrees of freedom.
Degrees of freedom are the possible values minus the estimated values.
The possible values = manifest variables*(manifest variables +1)/2

The model works when you have enough manifest variables plus you have degrees of freedom of zero.

Scaling can help you understand. Set a manifest variable to 1, name the model and use fit from specific name.
```{r}
Data <-read.csv('../cleaned_data/all_immunisation_seifa.csv')
str(Data)
#think about transforming federal electorates by left and right scores?
```
```{r}
#Select the manifest variables
#IRSAD_SCORE, IRSD_SCORE,IEO_SCORE, IER_SCORE, (or try all seifa numbers first) mean_tax, electorate, PHN number, pc_immun_class, year, age, postcode?
#think about factoring electorate into LEFT for Greens and Independents and Labor who are RED and RIGHT for Libs, Nats, Conservative Independents

#Latent variable is immun_class - let's try a single factor model
#latent variable i s pc immun in this experiment
imm.model <- 'pc_immun_class =~ mean_tax+IRSD_SCORE+IRSAD_SCORE+IER_SCORE+IEO_SCORE+PHN_number'
imm.fit <- cfa(model=imm.model,
                  data = Data)
summary(imm.fit, standardized = TRUE, fit.measures = TRUE)
  
```
#the single factor model is very poor fitting
Let's try some different variables and see how it comes together
```{r}
imm.model2 <- 'pc_immun_class =~ mean_tax+PHN_number+age
age =~ IRSD_MAXS+IRSD_MINS+IRSAD_MAXS+IRSAD_MINS+IER_MAXS+IER_MINS+IEO_MAXS+IEO_MINS'
imm.fit2 <- cfa(model=imm.model2,
                  data = Data)
summary(imm.fit2, standardized = TRUE, fit.measures = TRUE)
  
```
```{r}
imm.model3 <- 'pc_immun_class =~ IRSD_MAXS+IRSD_MINS+IRSAD_MAXS+IRSAD_MINS+IER_MAXS+IER_MINS+IEO_MAXS+IEO_MINS
postcode=~ PHN_number+age+IRSD_SCORE+IRSAD_SCORE+IER_SCORE+IEO_SCORE'
imm.fit3 <- cfa(model=imm.model3,
                  data = Data)
summary(imm.fit3, standardized = TRUE, fit.measures = TRUE, rse = TRUE)
  
```
```{r}
imm.model4 <- 'pc_immun_class =~ mean_tax+ IRSD_MAXS+IRSD_MINS+IRSAD_MAXS+IRSAD_MINS+IER_MAXS+IER_MINS+IEO_MAXS+IEO_MINS
age=~ pc_immun_class+IRSD_SCORE+IRSAD_SCORE+IER_SCORE+IEO_SCORE+IRSD_URP+IRSAD_URP+IER_URP+IEO_URP'
imm.fit4 <- cfa(model=imm.model4,
                  data = Data)
summary(imm.fit4, standardized = TRUE, fit.measures = TRUE)
#v bad
```
```{r}
imm.model5 <- 'pc_immun_class =~ total_tax+mean_tax+ IRSD_MAXS+IRSD_MINS+IRSAD_MAXS+IRSAD_MINS+IER_MAXS+IER_MINS+IEO_MAXS+IEO_MINS+ IRSD_SCORE+IRSAD_SCORE+IER_SCORE+IEO_SCORE'
imm.fit5 <- cfa(model=imm.model5,
                  data = Data)
summary(imm.fit5, standardized = TRUE, fit.measures = TRUE)
```
```{r}
#bring in new data
newdata <- read.csv('../cleaned_data/all_immunisation_elecscore.csv')
str(newdata)
```
##let's try a model with the elec scores against the latent variable of pc_immun_class - will have to include years in some way too??? TALK TO ANT ABOUT YEARS???

```{r}
elec.model <- 'pc_immun_class =~ year+X2016_score+X2015_score+X2014_score+X2013_score+X2012_score+X2011_score'
elec.fit <- cfa(model=elec.model,
                  data = newdata)
summary(elec.fit, standardized = TRUE, fit.measures = TRUE)
  #cos the election scores have a linear relationship, the model can't happen
```
```{r}
#try it just for 2016
elec.model2 <- 'pc_immun_class =~mean_tax+X2016_score+year+ IRSD_MAXS+IRSD_MINS+IRSAD_MAXS+IRSAD_MINS+IER_MAXS+IER_MINS+IEO_MAXS+IEO_MINS+ IRSD_SCORE+IRSAD_SCORE+IER_SCORE+IEO_SCORE'
elec.fit2 <- cfa(model=elec.model2,
                  data = newdata)
summary(elec.fit2, standardized = TRUE, fit.measures = TRUE)
  
```


```{r}
elec.model2 <- 'pc_immun_class =~ _score+IRSD_SCORE+IRSAD_SCORE+IER_SCORE+IEO_SCORE+IRSD_URP+IRSAD_URP+IER_URP+IEO_URP
##Selecting variables for SEM 
I need to transform mean_tax in some way to be relative to the other numbers??? Not sure how to do that

Also wondering
You can use confirmatory factor analysis
https://www.youtube.com/watch?v=1yyhdgZ6pYE

Estimate columns gives you the factor - lavaan constrains the first manifest variable, but if you need to constrain the others

The first variable is constrained to equal 1

COVARIANCES - between latent variables, lavaan does this by default

lavaan uses unit loading default on latent variables and takes the first variale to equal one unless you tell it otherwise. If you want to use a different variable then you pre-multiply first variable NA*x1 

SEM modelling in Lavaan
Step one: specify a model that might only be conceptual
Step two: R estimates the parameters
Step three: request the results
There are modifications that can be made to commands you put in. 

Regression - regress the left hand on to the right hand variable with a tilde

When R estimates parameters, you can use sem(fit.model, data = whatever) and you will only see basic results with summary command. Lavaan doesn't give all the results it has stored, estimates are unstandardized coefficients, so add standardized = TRUE is you want me, and add fit.measures = T, if you want r squared you use rse=TRUE too.

You can also specify indirect, direct and total effects on variables.
indirect effect = a*b *a path times p path) have to use colon and equal

#MUltiple variables at once are multiple lines and latent coompared to indicator/manifest variables

IRSAD_SCORE, IRSD_SCORE, mean_tax, electorate, PHN number, pc_immun_class, year, age, postcode?
Think about transforming electorate into LEFT for Greens and Independents and Labor who are RED and RIGHT for Libs, Nats, Conservative Independents - making it numeric

My latent variable could be: vaccine trust as measured by Google search demand?

 
##Experiment & hypothesis
Manifest variables are - PHN_code, Index.type, Time, Maximum.score.for
Standardized loadings - loadings show the strength of the relationship of the manifest variables - standardized loadings often easier to interpret.
includ e- standardised = TRUE - in the summary to get these standardized loadings, which are easier

std.lv - would be the solution is you set it to the latent variable. 

People often use a criteria of 0.3 as an acceptable loading.

Model  fit like CFI and TLI work (want them to be close to1)
Badness of fit like RMSEA and SRMR can be used (want them to be 0 - Davd A Kenny website pn measuring model fit)

summary(visual.fit, standardized = TRUE, fit.measures = TRUE)
Use thisc ommand to see fit

Models can be single factor or multi factor


```{r pressure, echo=FALSE}
plot(pressure)
```

#Multiple latent variables and relationships

visual.model (1 latent variable and 6 manifest variables) - combining visual skills and speed skills

Separate the model into two smaller models with 3 manifest variables each - first the models won't be identified and will have zero degrees of freedom - identification is tied to the numbers of variables you estimate

We want to fix models to have one degree of freedom, and you do this by specifying constraints. Set parameters to be equal and only calculate one number instead of several. x2 and x3 can have the same loading value by typing a* - the first variable is the marker variable used to scale the model.

EG
visual.model <- 'visual =~ x1 + a*x2 + a*x3'
data = HolzingerSwineford1939)    
summary(visual.fit, standardized = TRUE, fit.measures = TRUE)
OUTPUT:
  Number of observations                           301

  Estimator                                         ML
  Minimum Function Test Statistic                3.783
  Degrees of freedom                                 1
  P-value (Chi-square)                           0.052

                          ___

Latent Variables:
                   Estimate  Std.Err  z-value  P(>|z|)   Std.lv  Std.all
  visual =~                                                             
    x1                1.000                               0.745    0.639
    x2         (a)    0.910    0.142    6.397    0.000    0.678    0.562
    x3         (a)    0.910    0.142    6.397    0.000    0.678    0.614
    

Z score on latent and manifest variables

Splitting into two separate models means you don't capture the relationship between the two variables - specifying a multifactor model is better

twofactor.model <- 'visual =~ x1 + x2 + x3 
    speed =~ x7 + x8 + x9'
    summary(twofactor.fit, standardized = TRUE, fit.measures = TRUE)
    
    Analyze the model with CFA and summary functions
    
    OUTPUT
    Number of observations                           301

  Estimator                                         ML
  Minimum Function Test Statistic               47.413
  Degrees of freedom                                 8
  P-value (Chi-square)                           0.000
    
    Both latent variables and 6 manifeset variables.
  
  
  #lavaan by default makes manifest variables covariance checks
  
  
